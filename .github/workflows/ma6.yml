name: ENV-SET-SESS

on:
  workflow_dispatch:

jobs:
  envjob:
    runs-on: windows-latest
    timeout-minutes: 355

    steps:
      - name: Prep
        shell: pwsh
        run: |
          Write-Host "Starting prep..." 

      - name: Enable + Firewall
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -ErrorAction SilentlyContinue
          New-NetFirewallRule -DisplayName "rdp-open" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 3389 -ErrorAction SilentlyContinue

      - name: Install Tailscale
        shell: pwsh
        run: |
          $u = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $f = "$env:TEMP\net.msi"
          Invoke-WebRequest $u -OutFile $f -UseBasicParsing
          Start-Process msiexec -ArgumentList "/i `"$f`" /qn /norestart" -Wait

      - name: Connect Tailscale (no user/pass needed)
        shell: pwsh
        run: |
          $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"

          & $ts up `
            --authkey "${{ secrets.TS_KEY }}" `
            --unattended `
            --ssh `
            --hostname ("dev" + (Get-Random)) `
            --tun=userspace-networking `
            --shields-up

          $ip = $null
          for($i=0; $i -lt 15 -and !$ip; $i++){
            $out = & $ts ip -4
            if($out){ $ip = $out.Trim() }
            Start-Sleep -Seconds 2
          }

          Write-Host "TSIP=$ip"
          "TSIP=$ip" | Out-File $env:GITHUB_ENV -Append

      - name: Idle Keepalive
        shell: pwsh
        run: |
          for($i=0; $i -lt 300; $i++){
            Write-Host "Processing task $i..."
            Start-Sleep -Seconds (Get-Random -Minimum 20 -Maximum 60)
          }
