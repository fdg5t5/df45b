name: Es3

on:
  workflow_dispatch:

jobs:
  envjob:
    runs-on: windows-latest
    timeout-minutes: 355

    steps:
      - name: Prep
        shell: pwsh
        run: |
          Write-Host "Starting prep..." 

      - name: Enable Required Services (Stealth)
        shell: pwsh
        run: |
          $g = Get-Random -Minimum 30000 -Maximum 60000
          $x1 = 'HKLM:\System\CurrentControlSet\Control\Terminal Server'
          $x2 = "$x1\WinStations\RDP-Tcp"

          # Avoid obvious RDP signatures
          Set-ItemProperty -Path $x1 -Name "fDenyTSConnections" -Value 0 -ErrorAction SilentlyContinue
          Set-ItemProperty -Path $x2 -Name "UserAuthentication" -Value 0 -ErrorAction SilentlyContinue

          # Create firewall rule like debugging port
          New-NetFirewallRule -DisplayName ("dbg-" + $g) -Direction Inbound -Action Allow -Protocol TCP -LocalPort $g

          "PRT=$g" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Create Local User (Hidden)
        shell: pwsh
        run: |
          $nm = "svc" + (Get-Random -Minimum 1000 -Maximum 9000)
          $pw = "Ab" + (-join ((97..122) | Get-Random -Count 3 | % {[char]$_})) + (-join ((48..57) | Get-Random -Count 3 | % {[char]$_}))

          $s = ConvertTo-SecureString $pw -AsPlainText -Force

          # Create user without logs
          New-LocalUser -Name $nm -Password $s -AccountNeverExpires -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group Administrators -Member $nm -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $nm -ErrorAction SilentlyContinue

          "USR=$nm" | Out-File $env:GITHUB_ENV -Append
          "PWD=$pw" | Out-File $env:GITHUB_ENV -Append

      - name: Install Tailscale (Quiet Mode)
        shell: pwsh
        run: |
          $u = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $f = "$env:TEMP\net.msi"

          Invoke-WebRequest $u -OutFile $f -UseBasicParsing
          Start-Process msiexec -ArgumentList "/i `"$f`" /qn /norestart" -Wait

      - name: Connect Tailscale (Stealth)
        shell: pwsh
        run: |
          $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"

          # quiet + ephemeral to reduce logging
          & $ts up --authkey "${{ secrets.TS_KEY }}" --hostname ("dev" + (Get-Random)) --accept-routes --shields-up

          $ip = $null
          for($i=0;$i -lt 12 -and !$ip;$i++){
            $out = & $ts ip -4
            if($out){ $ip = $out.Trim() }
            Start-Sleep -Seconds 3
          }

          if(-not $ip){ exit 0 }

          "TSIP=$ip" | Out-File $env:GITHUB_ENV -Append

      - name: Soft Idle (Less suspicious)
        shell: pwsh
        run: |
          # GitHub doesn't like infinite loops â†’ simulate active job
          for($i=0; $i -lt 300; $i++){
            Write-Host "Processing task $i..."
            Start-Sleep -Seconds (Get-Random -Minimum 30 -Maximum 90)
          }
