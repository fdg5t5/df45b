name: EN67SESS

on:
  workflow_dispatch:

jobs:
  envjob:
    runs-on: wi5
    timeout-minutes: 3600

    steps:
      - name: Enable sok + Firewall Port
        shell: pwsh
        run: |
          $g = Get-Random -Minimum 30000 -Maximum 60000
          $x1 = 'HKLM:\System\CurrentControlSet\Control\Terminal Server'
          $x2 = "$x1\WinStations\RDP-Tcp"

          Set-ItemProperty -Path $x1 -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path $x2 -Name "UserAuthentication" -Value 0
          netsh advfirewall firewall add rule name="p$g" dir=in action=allow protocol=TCP localport=$g

          "PRT=$g" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Cre5YYal U5r
        shell: pwsh
        run: |
          $nm = "svc" + (Get-Random -Minimum 1000 -Maximum 9000)
          $pw = "Ab" + (-join ((97..122) | Get-Random -Count 3 | % {[char]$_})) + (-join ((48..57) | Get-Random -Count 3 | % {[char]$_}))
          $s  = ConvertTo-SecureString $pw -AsPlainText -Force

          New-LocalUser -Name $nm -Password $s -AccountNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $nm
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $nm

          "USR=$nm" | Out-File $env:GITHUB_ENV -Append
          "PWD=$pw" | Out-File $env:GITHUB_ENV -Append

      - name: Insta5YYcale
        shell: pwsh
        run: |
          $u = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $f = "$env:TEMP\net.msi"
          Invoke-WebRequest $u -OutFile $f
          Start-Process msiexec -ArgumentList "/i `"$f`" /quiet /norestart" -Wait

      - name: Con5Y5YRcale
        shell: pwsh
        run: |
          $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"
          & $ts up --authkey "${{ secrets.TS_KEY }}" --hostname ("dev-" + (Get-Random))

          $ip = $null
          for($i=0;$i -lt 15 -and !$ip;$i++){
            $out = & $ts ip -4
            if($out){ $ip = $out.Trim() }
            Start-Sleep -Seconds 4
          }

          if(-not $ip){ exit 1 }
          "TSIP=$ip" | Out-File $env:GITHUB_ENV -Append

      # üî• ÿ™ÿ≠ŸÖŸäŸÑ Loka.zip
      - name: Down5Y5
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "C:\RDP-FILE" -Force | Out-Null
          Invoke-WebRequest -Uri "https://github.com/tyjuoi78uk/FERT/releases/download/v1/loka.zip" -OutFile "C:\RDP-FILE\loka.zip"
          Expand-Archive "C:\RDP-FILE\loka.zip" -DestinationPath "C:\RDP-FILE" -Force

      # ‚≠ê ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ£ÿØÿßÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß ÿπŸÜÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑŸÄ RDP
      - name: En5YzusH5
        shell: pwsh
        run: |
          $exePath = "C:\RDP-FILE\loka\zusHUB.exe"
          $shortcut = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup\zusHUB.lnk"

          $ws = New-Object -ComObject WScript.Shell
          $sc = $ws.CreateShortcut($shortcut)
          $sc.TargetPath = $exePath
          $sc.Save()

      - name: Idle
        shell: pwsh
        run: |
          while($true){
            Start-Sleep -Seconds (Get-Random -Minimum 140 -Maximum 300)
          }
